class Base{constructor(){this.host=null,this.dummy=this.dummy.bind(this),this.sleep=this.sleep.bind(this),this.get=this.get.bind(this),this.http=this.http.bind(this),this.httpResponseSimple=this.httpResponseSimple.bind(this),this.httpResponseBody=this.httpResponseBody.bind(this),this.jsonParse=this.jsonParse.bind(this),this.checkIfObject=this.checkIfObject.bind(this),this.startHttpServer=this.startHttpServer.bind(this),this.startFileServer=this.startFileServer.bind(this),this.matchIpRange=this.matchIpRange.bind(this)}dummy(t,s){s(t)}sleep(t,s){this.setTimeout(s,1e3*t)}get(t,s){this.http({url:t,method:"GET",body:null},s)}http(t,s){var e=t.url,i=t.method,r=t.body,n=new XMLHttpRequest;if(t.headers)for(var o=Object.keys(t.headers),h=0;h<o.length;h++)n.setRequestHeader(o[h],t.headers[o[h]]);n.open(i,e,!0),s&&(n.onreadystatechange=function(){4==n.readyState&&(n.status>=200&&n.status<=299?s({headers:n.getAllResponseHeaders(),body:n.responseText,status:n.status,statusMessage:n.statusText}):n.status>=300?s({error:`HTTP Status ${n.status}${void 0!==XMLHttpRequest.statusMessage?`, with message: ${n.statusMessage}`:""}`}):0===n.status&&s({error:"Connection interrupted"}))},n.ontimeout=function(){s({error:"Connection timed out"})}),null!==r?n.send(r):n.send()}httpResponseSimple(t){if(t.error)throw new Error(t.error);if(void 0!==t.status&&parseInt(t.status)<400)return!0;throw new Error("Framework returned with a HTTP code > 400")}httpResponseBody(t){if(t.error)throw new Error(t.error);if(void 0!==t.status&&parseInt(t.status)<400&&void 0!==t.body)return!0;throw new Error("Framework returned with a HTTP code > 400 or no body (yet expected)")}jsonParse(t,s){try{s(JSON.parse(t))}catch(t){throw new Error("Error parsing json at jsonParse step")}}checkIfObject(t){if("object"==typeof t)return!0;throw new Error(`${t} is not an Object`)}startHttpServer(t,s){throw Error("This is no longer supported in the web version, please point your test to the webserver instead")}startFileServer(t){throw Error("This is no longer supported in the web version, please point your test to the webserver instead")}matchIpRange(t,s){throw Error("This is no longer supported in the web version, local server support is disabled. Please update your test")}}window.plugins=window.plugins||{},window.plugins.Base=Base;class Framework extends Base{constructor(){super(),this.up="0x0001",this.down="0x0002",this.right="0x0004",this.left="0x0003",this.esc="0x0009",this.exit="0x0009",this.back="0x0032",this.enter="0x002B",this.menu="0x8010",this.guide="0x800A",this.key=this.key.bind(this),this.keyPress=this.keyPress.bind(this),this.keyRelease=this.keyRelease.bind(this),this.setUrl=this.setUrl.bind(this),this.setYouTubeUrl=this.setYouTubeUrl.bind(this),this.getUrl=this.getUrl.bind(this),this.controllerActionCall=this.controllerActionCall.bind(this),this.startPlugin=this.startPlugin.bind(this),this.startAndResumePlugin=this.startAndResumePlugin.bind(this),this.stopPlugin=this.stopPlugin.bind(this),this.switchPlugin=this.switchPlugin.bind(this),this.startPlugins=this.startPlugins.bind(this),this.stopPlugins=this.stopPlugins.bind(this),this.getPlugin=this.getPlugin.bind(this),this.getPlugins=this.getPlugins.bind(this),this.getPluginState=this.getPluginState.bind(this),this.suspendPlugin=this.suspendPlugin.bind(this),this.resumePlugin=this.resumePlugin.bind(this),this.screenshot=this.screenshot.bind(this),this.getFPS=this.getFPS.bind(this),this.reboot=this.reboot.bind(this),this.getCpuLoad=this.getCpuLoad.bind(this),this.getMemoryUsage=this.getMemoryUsage.bind(this),this.getMemoryUsageForPlugin=this.getMemoryUsageForPlugin.bind(this),this.restartFramework=this.restartFramework.bind(this),this.startFramework=this.startFramework.bind(this),this.stopFramework=this.stopFramework.bind(this),this.killFramework=this.killFramework.bind(this),this.killallFramework=this.killallFramework.bind(this),this.requestProvisioning=this.requestProvisioning.bind(this),this.checkResumedOrActivated=this.checkResumedOrActivated.bind(this),this.checkSuspendedOrDeactivated=this.checkSuspendedOrDeactivated.bind(this)}key(t,s){this.keyPress(t,()=>{this.keyRelease(t,s)})}keyPress(t,s){var e=JSON.stringify({code:t}),i={url:`http://${host}:80/Service/RemoteControl/Web/Press`,body:e,method:"PUT"};this.http(i,s)}keyRelease(t,s){var e=JSON.stringify({code:t}),i={url:`http://${host}:80/Service/RemoteControl/Web/Release`,body:e,method:"PUT"};this.http(i,s)}setUrl(t,s){var e=JSON.stringify({url:t}),i={url:`http://${host}:80/Service/WebKitBrowser/URL`,method:"POST",body:e,headers:{"Content-Type":"application/json","Content-Length":e.length}};this.http(i,s)}setYouTubeUrl(t,s){var e=JSON.stringify({url:t}),i={url:`http://${host}:80/Service/YouTube/URL`,method:"POST",body:e,headers:{"Content-Type":"application/json","Content-Length":e.length}};this.http(i,s)}getUrl(t,s){this.getPlugin("WebKitBrowser",t=>{var e=JSON.parse(t.body);s(e.url)})}controllerActionCall(t,s){var e={url:`http://${host}:80/Service/Controller/${t.action}/${t.plugin}`,method:"PUT"};this.http(e,s)}startPlugin(t,s){var e={action:"Activate",plugin:t};this.controllerActionCall(e,s)}startAndResumePlugin(t,s){this.startPlugin(t,()=>{setTimeout(resumePlugin,300,t,s)})}stopPlugin(t,s){var e={action:"Deactivate",plugin:t};this.controllerActionCall(e,s)}switchPlugin(t,s){var e={action:"Switch",plugin:t};this.controllerActionCall(e,s)}startPlugins(t,s){for(var e=0;e<t.length;e++)e==t.length-1?setTimeout(this.startPlugin.bind(this),1e3*e,t[e],s):setTimeout(this.startPlugin.bind(this),1e3*e,t[e])}stopPlugins(t,s){for(var e=0;e<t.length;e++)e==t.length-1?setTimeout(this.stopPlugin.bind(this),1e3*e,t[e],s):setTimeout(this.stopPlugin.bind(this),1e3*e,t[e])}getPlugin(t,s){var e={url:`http://${host}:80/Service/${t}`,method:"GET"};this.http(e,s)}getPlugins(t,s){var e={url:`http://${host}:80/Service/Controller/Plugins`,method:"GET"};this.http(e,s)}getPluginState(t,s){this.getPlugin("Controller",e=>{for(var i=JSON.parse(e.body),r=0;i.plugins.length;r++){var n=i.plugins[r];if(n.callsign===t){s(n.state);break}if(r===i.plugins.length-1)throw new Error("Plugin not found in Frameworks response")}})}suspendPlugin(t,s){var e={url:`http://${host}:80/Service/${t}/Suspend`,method:"POST"};this.http(e,s)}resumePlugin(t,s){var e={url:`http://${host}:80/Service/${t}/Resume`,method:"POST"};this.http(e,s)}reboot(t,s){var e={url:`http://${host}:80/Service/Controller/Harakiri`,method:"PUT"};this.http(e,s)}screenshot(t,s){var e=`http://${host}:80/Service/Snapshot/Capture?`+moment().valueOf();fetchImageData(e,t=>{s(t)})}getFPS(t,s){this.getPlugin("WebKitBrowser",t=>{var e=JSON.parse(t.body),i=parseInt(e.fps);s(i)})}getCpuLoad(t,s){this.getPlugin("DeviceInfo",t=>{var e=JSON.parse(t.body);if(void 0!==e.SystemInfo&&void 0===e.systeminfo)s(parseFloat(e.SystemInfo.CpuLoad));else{if(void 0!==e.SystemInfo||void 0===e.systeminfo)throw Error("Cannot find systemInfo Cpu load on DeviceInfo plugin response");s(parseFloat(e.systeminfo.cpuload))}})}getMemoryUsage(t,s){getPlugin("DeviceInfo",t=>{var e,i,r=JSON.parse(t.body);if(void 0!==r.SystemInfo&&void 0===r.systeminfo)e=parseInt(r.SystemInfo.FreeRam),i=parseInt(r.SystemInfo.TotalRam);else{if(void 0!==r.SystemInfo||void 0===r.systeminfo)throw Error("Cannot find systemInfo on DeviceInfo plugin response");e=parseInt(r.systeminfo.freeram),i=parseInt(r.systeminfo.totalram)}s(Math.round(e/i*100))})}getMemoryUsageForPlugin(t,s){this.getPlugin("Monitor",e=>{for(var i=JSON.parse(e.body),r=0;r<i.length;r++){var n=i[r];if(console.log("Checking "+n.name+" === "+t),n.name===t)return void s(n)}throw Error(`Cannot find ${t} in data returned by Monitor`)})}startFramework(t){this.exec({cmd:"nohup WPEFramework -b &",cbWhenStarted:!0},s=>{if(s)throw new Error(s);setTimeout(t,5e3,!0)})}stopFramework(t,s){this.stopProcess("WPEFramework",s)}killFramework(t,s){this.killProcess("WPEFramework",s)}killallFramework(t,s){this.killProcess("WPEFramework",t=>{!0===t?killProcess("WPEProcess",s):s(!1)})}restartFramework(t,s){this.killallFramework(t,e=>{if(!0!==e)throw new Error("Error while restarting Framework");setTimeout(startFramework,5e3,t,s)})}requestProvisioning(t,s){var e={url:`http://${host}:80/Service/Provisioning`,method:"PUT"};this.http(e,s)}checkResumedOrActivated(t){if("resumed"===t||"activated"===t)return!0;throw Error(`Expected state to be resumed or activated, while state was ${t}`)}checkSuspendedOrDeactivated(t){if("suspended"===t||"deactivated"===t)return!0;throw Error(`Expected state to be suspended or deactivated, while state was ${t}`)}}window.plugins=window.plugins||{},window.plugins.Framework=Framework;class Message{constructor(){this.verbose=!1}send(t){!0===this.verbose&&console.log(`${this.type()} \t ${JSON.stringify(this)}`),void 0!==t&&void 0!==t.postMessage?t.postMessage(this):postMessage(this)}}class Init extends Message{constructor(){super(),this.name="Init",this.test="",this.host="",this.debug=!1,this.states={initFailure:-1,loaded:0,init:1,initReady:2,loadTest:3},this.state=-1}initialize(t){this.state=this.states.init,this.send(t)}setInitReady(t){this.state=this.states.initReady,this.send(t)}setInitFailure(t){this.state=this.states.initFailure,this.send(t)}setDebug(){this.debug=!0}setLoadTest(t,s,e){this.test=t,this.host=s,this.state=this.states.loadTest,this.send(e)}}class NeedImage extends Message{constructor(){super(),this.name="NeedImage",this.url="",this.imageData=""}setURL(t){this.url=t,this.send()}setImageData(t,s){this.imageData=t,this.send(s)}}class TestMessage extends Message{constructor(){super(),this.name="TestMessage",this.stepCount=0,this.result="",this.cleanup=!1,this.cleanupResult="",this.completed=!1,this.states={init:-1,start:0,timedout:1,error:2,success:3,notapplicable:4},this.state=this.states.init}setStepCount(t){this.stepCount=t}start(){this.state=this.states.start,this.send()}error(t){this.state=this.states.error,this.result=t,this.send()}timedout(t){this.state=this.states.timedout,this.result=t,this.send()}success(t){this.state=this.states.success,this.result=t,this.send()}notApplicable(t){this.state=this.states.notapplicable,this.result=t,this.send()}complete(t){this.completed=!0,this.send()}cleanedup(t){this.cleanup="true",this.cleanupResult=t,this.send()}}class StepMessage extends Message{constructor(t){super(),this.name="StepMessage",this.stepIdx=t,this.response=null,this.result=null,this.states={init:-1,start:0,response:1,success:2,failed:3,needuser:4},this.state=this.states.init}start(){this.state=this.states.start,this.send()}setResponse(t){this.state=this.states.response,this.response=t}success(t){this.state=this.states.success,this.result=t,this.send()}fail(t){this.state=this.states.failed,this.result=t,this.send()}needUser(){this._state=this.states.needuser,this.send()}}class RepeatMessage extends Message{constructor(t,s,e){super(),this.name="RepeatMessage",this.stepIdx=t,this.repeat={fromStep:s,toStep:e},this.states={init:-1,repeating:0,done:1},this.state=this.states.init,this.repeatByCount={remaining:null,total:null},this.repeatByTime={until:null,timesRepeated:null},this.repeatTypes={count:0,time:1},this.repeatType=this.repeatTypes.count}repeatCount(t,s){this.repeatType=this.repeatTypes.count,this.state=this.states.repeating,this.repeatByCount.remaining=t,this.repeatByCount.total=s,this.send()}timedRepeat(t,s){this.repeatType=this.repeatTypes.time,this.state=this.states.repeating,this.repeatByTime.until=t,this.repeatByTime.timesRepeated=s,this.send()}done(){this._state=this.states.done,this.send()}}class AttachToLogs{constructor(t){this.cb=t,this.ws=void 0}connect(t){this.ws=new WebSocket(`ws://${host}:9998/devtools/page/1`),this.ws.addEventListener("open",()=>{this.ws.send('{"id":1,"method":"Inspector.enable"}'),this.ws.send('{"id":22,"method":"Console.enable"}'),this.ws.send('{"id":23,"method":"Inspector.initialized"}'),t()}),this.ws.addEventListener("message",t=>{var s=JSON.parse(t);"Console.messageAdded"===s.method&&this.cb(null,s.params.message.text)}),this.ws.addEventListener("error",t=>{throw Error(t)}),this.ws.addEventListener("close",()=>{console.log("connection closed")})}disconnect(){console.log("Closing attachToLogs websocket connection"),this.ws&&this.ws.close()}}window.plugins=window.plugins||{},window.plugins.AttachToLogs=AttachToLogs;