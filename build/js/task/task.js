const DEFAULT_TIMEOUT=3e5,DEFAULT_TASK_TIMEOUT=36e5;var verbose=!1,debug=!1,window=this;function mergeObjects(e,t){for(var s in t)e[s]=t[s]}function globalize(e){var t=require(e);mergeObjects(global,t)}let bootStep=0;var maxSteps,steps,repeatStepMessage,repeatMessage,stepMessage,stepList,testId,timer,taskTimer,curIdx=-1,processEndRequested=!1,timedOut=!1;this.test=test=void 0,console.log("Beep boop, task.js loaded"),addEventListener("message",function(e){let t=e.data;void 0!==t.name&&("Init"===t.name&&1===t.state&&(debug=t.debug,init()),"Init"===t.name&&3===t.state&&""!==t.test&&(this.host=e.data.host,initTest(e.data.test)),"NeedImage"===t.name&&""!==t.imageData&&void 0!==this.fetchImageDataCallback&&this.fetchImageDataCallback(t.imageData))},!1);var bootSequence={loadScript:function(e){importScripts("../lib/moment.min.js"),!0===debug?(importScripts("../plugins/base.js"),importScripts("../plugins/framework.js"),importScripts("../plugins/messages.js")):importScripts("../plugins.js"),testMessage=new TestMessage,needImage=new NeedImage,m_init=new Init,e()},loadPlugins:function(e){if(console.debug("Load base & framework plugin"),void 0==window.plugins||void 0===window.plugins.Framework||void 0===window.plugins.Base)return void e(null,2e3);let t=new window.plugins.Framework;mergeObjects(window,t),e()},initReady:function(e){m_init.setInitReady()}};function loaded(){postMessage({name:"Init",state:0})}function init(){var e=Object.keys(bootSequence);bootStep>e.length-1||bootSequence[e[bootStep]]((e,t)=>{null===e&&void 0!==t?(console.debug(`Retrying bootstep ${bootStep} in ${e} ms`),setTimeout(init,t)):void 0!==e?(console.debug(`Bootstep ${bootStep} completed, starting next in ${e} ms`),bootStep++,setTimeout(init,e)):(console.debug(`Bootstep ${bootStep} completed, starting next`),bootStep++,init())})}var testIsNA=!1,NotApplicable=function(e){testIsNA=!0,testMessage.notApplicable(e)},fetchImageData=function(e,t){this.fetchImageDataCallback=t,needImage.setURL(e)};function initTest(e){try{importScripts("../tests/"+e+".js")}catch(e){return void(!0!==testIsNA&&process_end("Error, could not load test "+e))}if(test&&void 0!==test.extends)try{var t=test;importScripts("../tests/"+test.extends+".js"),mergeObjects(t.steps,test.steps),test=t}catch(e){process_end("Could not load test to extend, test file not found")}test&&void 0!==test.requiredPlugins&&test.requiredPlugins.length>0?getPlugins(null,e=>{try{for(var t=JSON.parse(e.body).plugins,s=[],i=0;i<t.length;i++)s.push(t[i].callsign);for(var a=0;a<test.requiredPlugins.length;a++)-1===s.indexOf(test.requiredPlugins[a])?NotApplicable(`Build does not support ${test.requiredPlugins[a]}`):a===test.requiredPlugins.length-1&&startTest()}catch(e){process_end("Failed to retrieve plugins from Framework while checking requiredPlugins")}}):startTest()}function startTest(){!0!==testIsNA&&(stepList=Object.keys(test.steps),maxSteps=stepList.length,testMessage.setStepCount(maxSteps-1),testMessage.start(),taskTimer=setTimeout(timedout,void 0!==test.timeout?1e3*test.timeout:DEFAULT_TASK_TIMEOUT),lookForNextStep())}function timedout(){testMessage.timedout(),checkAndCleanup(()=>{testMessage.complete(),setTimeout(close,1e3)})}function checkAndCleanup(e){void 0!==test.cleanup?test.cleanup(t=>{testMessage.cleanedup(t),testMessage.complete(),setTimeout(e,1e3)}):e()}function process_end(e){!0===processEndRequested&&close(1),processEndRequested=!0,clearTimeout(timer),void 0!==e&&testMessage.error(e),void 0!==e?checkAndCleanup(()=>{testMessage.complete(),setTimeout(close,1e3)}):(testMessage.complete(),setTimeout(close,1e3))}function lookForNextStep(){clearTimeout(timer);var e=curIdx+1;if(e>=maxSteps)return testMessage.success(),void process_end();var t=test.steps[stepList[e]];if(void 0!==t.goto){repeatMessage=new RepeatMessage(e,stepList[e],t.goto);var s=stepList.indexOf(t.goto);t.repeat?(void 0===t.repeatTotal&&((repeatStepMessage=new StepMessage(curIdx+1)).start(),t.repeatTotal=t.repeat),repeatMessage.repeatCount(t.repeat,t.repeatTotal),t.repeat-=1,t.repeat<=0?(repeatMessage.done(),repeatStepMessage.success(),curIdx+=1,lookForNextStep()):startStep(s)):t.repeatTime&&(void 0===t.repeatTimeStamp&&((repeatStepMessage=new StepMessage(curIdx+1)).start(),t.repeatTimeStamp=moment().add(t.repeatTime,"minutes").format(),t.repeatTimes=0),t.repeatTimes++,moment().isAfter(t.repeatTimeStamp)?(repeatMessage.done(),repeatStepMessage.success(),curIdx+=1,lookForNextStep()):(repeatMessage.timedRepeat(t.repeatTimeStamp,t.repeatTimes),startStep(s)))}else void 0!==t.user?askUser(curIdx+1):startStep(curIdx+1)}function startStep(e){curIdx=e,this.currentStep=test.steps[stepList[curIdx]],this.previousStep=void 0,curIdx>0&&(this.previousStep=test.steps[stepList[curIdx-1]]),void 0!==stepMessage&&delete stepMessage,(stepMessage=new StepMessage(curIdx)).start(),timedOut=!1;var t=void 0!==this.currentStep.timeout?1e3*this.currentStep.timeout:DEFAULT_TIMEOUT;timer=setTimeout(timedout,t,curIdx);var s=void 0!==this.currentStep.sleep?1e3*this.currentStep.sleep:1e3,i=void 0!==this.currentStep.test?this.currentStep.test:dummy;function a(e){test.steps[stepList[curIdx]].response=e,stepMessage.setResponse(e),validateStep(curIdx,e)}void 0===this.currentStep.params&&(this.currentStep.params=a),setTimeout(function(t){try{i(currentStep.params,a)}catch(t){process_end(`Error executing step ${e}: ${t}`)}},s)}function validateStep(e,t){var s,i=!1,a=test.steps[stepList[e]];a.expect;if(void 0!==a.assert)a.assert==t?i=!0:s=`Step ${e}: expected ${a.assert} while result was ${t}`;else if(void 0!==a.validate&&!a.validate instanceof Function)a.validate==t?i=!0:s=`Step ${e}: expected ${a.assert} while result was ${t}`;else if(void 0!==a.validate&&a.validate instanceof Function){var o=a.validate;try{i=o(t)}catch(t){s=`Error executing validate on step ${e}: ${t}`}}else i=!0;!0===i?(stepMessage.success(s),lookForNextStep()):(stepMessage.fail(s),process_end(s))}function askUser(e){curIdx=e;var t=test.steps[stepList[curIdx]];(stepMessage=new StepMessage(curIdx)).start(),stepMessage.needUser();var s=void 0!==t.timeout?1e3*t.timeout:DEFAULT_TIMEOUT;timer=setTimeout(timedout,s,curIdx)}function userResponse(e){e.state()!==e.states.success?process_end(e.response()):lookForNextStep()}loaded();